# 开发环境 Dockerfile - 支持热重载
FROM rust:1.70-slim

# 安装开发依赖
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    libpq-dev \
    curl \
    && rm -rf /var/lib/apt/lists/*

# 安装 cargo-watch 用于热重载
RUN cargo install cargo-watch

# 设置工作目录
WORKDIR /app

# 复制 Cargo 文件
COPY backend/Cargo.toml backend/cargo.toml ./
COPY backend/media-server/Cargo.toml ./media-server/
COPY backend/media-wasm/Cargo.toml ./media-wasm/

# 预构建依赖以加速后续构建
RUN mkdir -p media-server/src media-wasm/src && \
    echo "fn main() {}" > media-server/src/main.rs && \
    echo "fn main() {}" > media-wasm/src/lib.rs && \
    cargo build --manifest-path media-server/Cargo.toml && \
    rm -rf media-server/src media-wasm/src

# 暴露端口
EXPOSE 8000

# 设置环境变量
ENV RUST_LOG=debug
ENV RUST_BACKTRACE=1

# 默认命令 (可以被 docker-compose 覆盖)
CMD ["cargo", "watch", "-x", "run", "--manifest-path", "media-server/Cargo.toml"]